<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.studysiba.mapper.MessengerMapper">
  
  	<select id="checkRoomId" resultType="String">
  		select roomId from message 
  		where ( id = #{id} AND toId = #{toId} ) OR ( id = #{toId} AND toId = #{id} )
  		group by roomId
  	</select>
  	
  	<insert id="sendMessage">
  		<selectKey keyProperty="no" resultType="long" order="BEFORE">
    		select coalesce(max(no+1),1) as no from message
  		</selectKey>
  		insert into message (no, roomId, type, id, toId, content, mRead, mDate )
  		values ( #{no}, #{roomId}, #{type}, #{id}, #{toId}, #{content}, #{mRead}, now() )
  	</insert>
  	
  	<select id="getRoomId" resultType="long">
  		select COALESCE(max(roomId+1),1) as roomId from message
  	</select>
  	
  	<select id="getMessage" resultType="com.studysiba.domain.messenger.MessageVO">
  		select message.*, my.profile as myProfile, other.profile as toProfile from 
		( select no, roomId, type, id, toId, content, mRead, date_format(mDate, '%Y년%m월%d일 %H시%i분') as mDate from message 
		where ( id = #{id} AND toId = #{toId} ) OR ( id = #{toId} AND toId = #{id}) ) message
		join member my
		on message.id = my.id
		join member other
		on message.toId = other.id
		order by message.mDate ASC
  	</select>
  	
  	<select id="getMessengerUserList" resultType="com.studysiba.domain.messenger.UserListVO">
  		select myInfo.id as preId, myInfo.nick as preNick, myInfo.proFile as preProfile, 
  		toInfo.id as lastId, toInfo.nick as lastNick, toInfo.proFile as lastProfile, 
  		coalesce(unread.unread,0) as unRead from 
		( select * from message where id=#{id} OR toId=#{id} group by roomId ) message
		left join 
		( select roomId,count(*) as unread from message where toId=#{id} group by roomId ) unread
		on message.roomId = unread.roomId
		left join
		member myInfo
		on message.id = myInfo.id
		left join
		member toInfo
		on message.toId = toInfo.id
		order by message.no DESC
  	</select>
  	
  	<delete id="deleteMessage">
  		delete from message where ( id = #{id} AND toId = #{toId} ) OR ( id = #{toId} AND toId = #{id} )
  	</delete>
  	
  	
  	
  </mapper>